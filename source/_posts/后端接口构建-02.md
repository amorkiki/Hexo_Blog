---
title: åŽç«¯æŽ¥å£æž„å»º-02
date: 2019-3-03 16:48:34
tags: [nodejs, myProject]
top_img: false
categories: project-share
aside: true
indexing: true
cover: https://tva1.sinaimg.cn/large/0081Kckwly1gkfm6ofo0dj31400u0q8j.jpg
---

å•¦å•¦å•¦~
ä»Šå¤©å†…å®¹æ¯”è¾ƒç®€å•ï¼Œé…ç½®ä¿¡æ¯çš„å¢žåˆ æ”¹æŸ¥æŽ¥å£ï¼Œæ²¡æœ‰å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯ç»†å¿ƒï¼Œç›´æŽ¥ä¸Šä»£ç å•¦~ðŸ‘‡

é…ç½®ä¿¡æ¯æŽ¥å£

- åˆ›å»º model--Profile.js

- æŒ‰ç…§ User.js æ ¼å¼è¿›è¡Œä¿®æ”¹

  ```js
  const mongoose = require("mongoose");
  const Schema = mongoose.Schema;

  // Create Schema
  const ProfileSchema = new Schema({
    type: {
      type: String,
      required: true,
    },
    b_name: {
      type: String,
      required: true,
    },
    author: {
      type: String,
      required: true,
    },
    isbn_num: {
      type: String,
    },
    status: {
      type: String,
    },
    remark: {
      type: String,
    },
    date: {
      type: Date,
      default: Date.now,
    },
  });

  module.exports = Profile = mongoose.model("profile", ProfileSchema);
  ```

- åœ¨ routers é‡Œåˆ›å»º profiles.js æŽ¥å£æ–‡ä»¶

- åˆ°å…¥å£æ–‡ä»¶ server.js ä¸­å¼•å…¥ profiles.jsï¼Œå¹¶ä½¿ç”¨

  ```js
  //å¼•å…¥profiles.js
  const profiles = require("./routers/api/profiles");

  app.use("/api/profiles", profiles);
  ```

- é…ç½® profiles.js æ–‡ä»¶ï¼ŒåŒæ ·å¼•å…¥ expressï¼Œrouterï¼Œpassportï¼Œä»¥åŠ Profile æ¨¡åž‹ï¼ˆProfile.jsï¼‰ï¼Œå…ˆå†™ä¸ªæµ‹è¯• get è¯·æ±‚ï¼Œæµ‹è¯•ä¸€ä¸‹

  ```js
  const express = require("express");
  const router = express.Router();
  const passport = require("passport");

  const Profile = require("../../models/Profile");

  // $route GET api/profiles/test
  // @desc  è¿”å›žè¯·æ±‚çš„jsonæ•°æ®
  // @access public
  router.get("/test", (req, res) => {
    res.json({ msg: "profile works" });
  });

  module.exports = router;
  ```

  â†“

  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghxaamvf3vj30ek0c7jrp.jpg)

æŽ¥å£ OK äº†ï¼ŒæŽ¥ä¸‹æ¥è¦èŽ·å–åˆ°ä¸€äº›ä¿¡æ¯ï¼Œæ·»åŠ ã€ç¼–è¾‘ã€åˆ é™¤

â†“

- æ·»åŠ ä¿¡æ¯æŽ¥å£ POST è¯·æ±‚

```js
// $route POST api/profiles/add
// @desc  åˆ›å»ºä¿¡æ¯æŽ¥å£
// @access private
router.post(
  "/add",
  passport.authenticate("jwt", { session: false }),
  (req, res) => {
    const profileFields = {};

    if (req.body.type) profileFields.type = req.body.type;
    if (req.body.b_name) profileFields.b_name = req.body.b_name;
    if (req.body.author) profileFields.author = req.body.author;
    if (req.body.isbn_num) profileFields.isbn_num = req.body.isbn_num;
    if (req.body.status) profileFields.status = req.body.status;
    if (req.body.remark) profileFields.remark = req.body.remark;

    new Profile(profileFields).save().then((profile) => {
      res.json(profile);
    });
  }
);
```

- æµ‹è¯•ä¸€ä¸‹~
  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghxc514z5ij30k70ey75i.jpg)

â†“

èŽ·å–ä¿¡æ¯

- èŽ·å–å…¨éƒ¨ä¿¡æ¯ï¼Œè¿™é‡Œç›´æŽ¥é‡‡ç”¨ GET å°±è¡Œ

  ```js
  // $route GET api/profiles/
  // @desc  èŽ·å–æ‰€æœ‰ä¿¡æ¯æŽ¥å£
  // @access private
  router.get(
    "/",
    passport.authenticate("jwt", { session: false }),
    (req, res) => {
      Profile.find()
        .then((profile) => {
          if (!profile) {
            return res.status(404).json("æ²¡æ‰¾åˆ°è¿™æ¡å†…å®¹å‘€@_@");
          }

          res.json(profile);
        })
        .catch((err) => res.status(404).json(err));
    }
  );
  ```

  æµ‹è¯•ä¸€ä¸‹~
  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghxcmar20zj30i60hmwfw.jpg)

- èŽ·å–å•ä¸ªä¿¡æ¯

  è¿˜æ˜¯é‡‡ç”¨ GET æ–¹å¼ï¼Œåªæ˜¯è¿™é‡Œé‡‡ç”¨ findOne()

  ```js
  // $route GET api/profiles/:id
  // @desc  èŽ·å–å•ä¸ªä¿¡æ¯æŽ¥å£
  // @access private
  router.get(
    "/:id",
    passport.authenticate("jwt", { session: false }),
    (req, res) => {
      Profile.findOne({ _id: req.params.id })
        .then((profile) => {
          if (!profile) {
            return res.status(404).json("æ²¡æ‰¾åˆ°è¿™æ¡å†…å®¹å‘€@_@");
          }

          res.json(profile);
        })
        .catch((err) => res.status(404).json(err));
    }
  );
  ```

  æµ‹è¯•ä¸€ä¸‹~

  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghxcsrrxadj30hf0g0q4a.jpg)

â†“

ç¼–è¾‘å†…å®¹ï¼ˆç±»ä¼¼æ·»åŠ å†…å®¹ï¼‰

è¿™é‡Œä½¿ç”¨ findOneAndUpdate æ–¹æ³•

```js
// $route POST api/profiles/edit
// @desc  ç¼–è¾‘ä¿¡æ¯æŽ¥å£
// @access private
router.post(
  "/edit/:id",
  passport.authenticate("jwt", { session: false }),
  (req, res) => {
    const profileFields = {};

    if (req.body.type) profileFields.type = req.body.type;
    if (req.body.b_name) profileFields.b_name = req.body.b_name;
    if (req.body.author) profileFields.author = req.body.author;
    if (req.body.isbn_num) profileFields.isbn_num = req.body.isbn_num;
    if (req.body.status) profileFields.status = req.body.status;
    if (req.body.remark) profileFields.remark = req.body.remark;

    Profile.findOneAndUpdate(
      { _id: req.params.id },
      { $set: profileFields },
      { new: true }
    ).then((profile) => res.json(profile));
  }
);
```

- æµ‹è¯•ï¼ˆä¿®æ”¹å‰ç«¯-->å‰ç«¯ ITï¼‰
  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghxd1awbzxj30gb0e875g.jpg)

â†“

åˆ é™¤å†…å®¹

```js
// $route POST api/profiles/delete/:id
// @desc  åˆ é™¤ä¿¡æ¯æŽ¥å£
// @access private
router.delete(
  "/delete/:id",
  passport.authenticate("jwt", { session: false }),
  (req, res) => {
    Profile.findOneAndRemove({ _id: req.params.id })
      .then((profile) => {
        profile.save().then((profile) => res.json(profile));
      })
      .catch((err) => res.status(404).res.json("åˆ é™¤å¤±è´¥å•¦~ >_<"));
  }
);
```

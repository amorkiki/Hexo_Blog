---
title: åå°æ¥å£æ„å»º-01
date: 2020-08-20 00:24:37
tags: [nodejs,myProject]
---
å†™åœ¨å‰é¢çš„è¯~~~

æ¯å¹´çš„è¯»ä¹¦è®¡åˆ’éƒ½ä¸äº†äº†ä¹‹....ä¹°äº†æ–°ä¹¦å¿˜äº†æ—§ä¹¦è¯´çš„å°±æ˜¯æˆ‘ğŸ¤¦â€â™€ï¸ğŸ¤¦â€â™€ï¸
so...æƒ³å»ºä¸€ä¸ªç§äººå›¾ä¹¦é¦†å°å¹³å°ï¼Œè®°å½•è´­ä¹°çš„ä¹¦å’Œæ¯æœ¬ä¹¦çš„é˜…è¯»è¿›åº¦

ä»Šå¤©å…ˆå†™ç‚¹å­¦ä¹ ã®åå°æ¥å£æ­å»ºæ­¥éª¤å’Œbugè§£å†³ï¼ˆbugä¸€å¡å¡ä¸‰å¹´æˆ‘æ˜¯ä»€ä¹ˆæ ·çš„å¿ƒæƒ…...)
ğŸ‘¨â€ğŸ’»â€

æ„å»ºæ¥å£æ–‡æ¡£ï¼šNode+express+jwt(å®ç°token)

> æ¥å£æ–‡æ¡£å†…å®¹ï¼šNodejs
>
> - å‡†å¤‡å·¥ä½œï¼š 
>   - æ­å»ºæœåŠ¡å™¨
>   - é“¾æ¥MongoDB
>   - æ­å»ºè·¯ç”±å’Œæ•°æ®æ¨¡å‹
> - æ³¨å†Œç™»å½•æ¥å£
>   - æ³¨å†Œæ¥å£æ•°æ®å­˜å‚¨
>   - å…¨çƒå…¬è®¤å¤´åƒ
>   - ç™»å½•æ¥å£æ•°æ®å­˜å‚¨
>   - JWTå®ç°token
----------------------------------------------
Node-appæ–‡ä»¶å¤¹ä¸‹ï¼šnpm init  åˆå§‹åŒ–é¡¹ç›®

![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwfpf0kcfj30ea05uaa8.jpg)



â†“

åœ¨VScodeé‡Œæ‰“å¼€é¡¹ç›®ï¼Œå¿«æ·é”®ctr+`åœ¨vscodeé‡Œæ‰“å¼€ç»ˆç«¯ï¼Œåœ¨å½“å‰node-appæ–‡ä»¶å¤¹åˆ›å»ºå…¥å£æ–‡ä»¶touch server.js

â†“

å®‰è£…expressåŒ…  npm install express

â†“

åœ¨å…¥å£æ–‡ä»¶å¼€å§‹æ­å»ºæœåŠ¡å™¨:  

- å¼•å…¥expressæ¡†æ¶   const express = **require**('express');

- å®ä¾‹åŒ–ä¸€ä¸ªapp,    const app = **express**();

- ç»™äºˆä¸€ä¸ªç«¯å£å·  const port = process.env.PORT **||** 5000;   (æœ¬åœ°ç«¯å£å·æ˜¯5000)

- ç›‘å¬ä¸€ä¸‹app, å¹¶æ‰“å°å¤„ç›¸åº”ç«¯å£å·

  ```js
  app.listen(port, () => {
    console.log(`Server is running on port ${port}`);
  })
  ```

â†“

åœ¨ç»ˆç«¯ node server.js å°±å¯ä»¥è¿è¡Œè¯¥é¡¹ç›®äº†ï¼Œä½†æ­¤æ—¶è¿˜æ²¡æœ‰è®¾ç½®ä»»ä½•è·¯ç”±ï¼Œæš‚æ—¶è¿˜æ— æ³•è®¿é—®å“¦~~

â†“

åœ¨å®ä¾‹åŒ–çš„appä¸‹è®¾ç½®ä¸ªè·¯ç”±ï¼š

```js
app.get("/", (req, res) => {
  res.send("hello");
});
```

â†“

ç”¨nodemon server.js å¯åŠ¨æœåŠ¡å™¨~~

â†“

åœ¨package.jsoné‡Œçš„scriptsé‡Œæ›´æ”¹è‡ªå®šä¹‰å‘½ä»¤

- npm run start  : é¡¹ç›®æœ€åä¸Šçº¿æ—¶
- npm run serverï¼šé¡¹ç›®è¿˜åœ¨å¼€å‘æ—¶ï¼Œå®æ—¶ç›‘æµ‹æ”¹å˜

```json
  "scripts": {
    "start": "node server.js",
    "server": "nodemon server.js"
  },
```

â†“

é“¾æ¥MongoDBæ•°æ®åº“:

- ç™»å½•mongodbçº¿ä¸Šæ•°æ®åº“ï¼Œæ–°å»ºæ•°æ®åº“
- ç”¨mongoDB Compass æ–¹å¼é“¾æ¥ mongodb+srv://amork:jing985464@cluster0.jiogy.mongodb.net/test

â†“

åœ¨é¡¹ç›®ä¸­å®‰è£…mongooseåŒ…  npm install mongoose

åœ¨server.jså…¥å£æ–‡ä»¶ä¸­å¼•å…¥const mongoose = **require**("mongoose");

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä½¿ç”¨mongooseå¯¹è±¡è¿æ¥æ•°æ®åº“

â†“

æˆ‘ä»¬æ–°å»ºä¸€ä¸ªä¸“ç”¨æ–‡ä»¶å¤¹configï¼Œæ–°å»ºæ–‡ä»¶keys.js,

åœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹ï¼Œexportsæ¨¡å—ï¼Œå†™å…¥mongoURIï¼šæ‹·è´çš„åœ°å€

```js
module.exports = {
  mongoURI: "mongodb+srv://amork:jing985464@cluster0.jiogy.mongodb.net/test",
};
```

åœ¨å…¥å£æ–‡ä»¶å¼•å…¥æ¨¡å—ï¼š

```js
const db = require("./config/keys").mongoURI;
```

è¿™æ ·åšçš„å¥½å¤„ï¼š å¯ä»¥æ‰‹åŠ¨æ›´æ”¹æ•°æ®åº“è¿æ¥çš„åœ°å€mongoURIï¼Œå¦‚æœæƒ³ç”¨æœ¬åœ°æ•°æ®åº“

è¿æ¥æ•°æ®åº“---mongoose.connect

```js
//connect to mongodb
mongoose
  .connect(db)
  .then(() => console.log("mongoDB connected"))
  .catch((error) => console.log(error));
```

æ­¤æ—¶terminalä¸­è‹¥è¿”å›mongoDB connectedï¼Œåˆ™è¡¨ç¤ºè¿æ¥æˆåŠŸ

â†“

å°é—®é¢˜ï¼šç»ˆç«¯ä¸­è¿˜ä¼šå‡ºç°å¦‚ä¸‹è­¦å‘Šï¼š
![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwfpgf84zj30q404tt9i.jpg)

è§£å†³ï¼š æ‹·è´{ useNewUrlParser: **true**, useUnifiedTopology: **true** } ç²˜è´´åˆ° connect(db, è¿™é‡Œ)

æ­¤æ—¶å‘ç°æ²¡æœ‰æŠ¥é”™å•¦~~

â†“

ä¸‹é¢å°±å¼€å§‹æ­å»ºè‡ªå·±çš„æ¥å£å•¦~

åˆ›å»ºæ–‡ä»¶å¤¹routers -->APIs --> æ–°å»ºæ–‡ä»¶users.js ç”¨æ¥ç”¨æˆ·ç™»å½•å’Œæ³¨å†Œ

- åŒç†å¼•å…¥expressï¼Œå†å®ä¾‹åŒ–ä¸€ä¸ªrouterï¼Œå¹¶åˆ›å»ºè·¯ç”±é“¾æ¥ï¼Œæœ€ååˆ«å¿˜äº†æš´éœ²å‡ºå»å“¦~

  ```js
  router.get("/test", (req, res) => {
    res.json({msg:"login works"})
  })
  //è¿™é‡Œresponseä¸€ä¸ªjsonå¯¹è±¡ï¼ŒåŒ…å«msg,è¡¨ç¤ºå½“è®¿é—®localhost:5000/testæ—¶ï¼Œä¼šè¿”å›msgé‡Œçš„è¯
  
  module.exports = router;
  ```

- åœ¨å…¥å£æ–‡ä»¶å¼•å…¥userè·¯ç”±ï¼Œå¹¶ä½¿ç”¨å®ƒ

  ```js
  //å¼•å…¥user.js
  const users = require("./routers/api/users");
  
  // ä½¿ç”¨routers
  app.use("/api/users", users);
  ```

- åœ¨æµè§ˆå™¨ä¸­è¾“å…¥localhostï¼š5000/api/users/test æ£€æŸ¥è·¯ç”±æ˜¯å¦è®¾ç½®æˆåŠŸ

  å½“ç„¶ä¹Ÿå¯ç”¨ç¬¬ä¸‰æ–¹å·¥å…·postmanæµ‹è¯•æ¥å£
  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwfpfhodmj30ca02sjr9.jpg)

â†“

åˆ›å»ºæ¨¡å‹å­˜å‚¨å¯¹åº”çš„æ•°æ®ï¼š

- åˆ›å»ºæ–‡ä»¶å¤¹models --> åˆ›å»ºUser.jsæ–‡ä»¶ï¼Œå¼•å…¥mongooseï¼ˆè¦å°†æ•°æ®å­˜å‚¨åœ¨å…¶ä¸­ï¼‰ï¼Œå†å®ä¾‹åŒ–ä¸€ä¸ªSchemaï¼Œåˆ›å»ºé›†åˆï¼Œå‘é›†åˆä¸­æ’å…¥æ•°æ®

  ```js
  const mongoose = require("mongoose");
  const Schema = mongoose.Schema;
  
  // Create Schema
  const UserSchema = new Schema({});
  ```

- åˆ›å»ºé›†åˆè§„åˆ™ï¼šç™»å½•å’Œæ³¨å†Œæ—¶ï¼Œéœ€è¦ä»€ä¹ˆï¼Œå°±åœ¨Schemaå¯¹è±¡ä¸­å†™ä»€ä¹ˆ(æš‚æ—¶å…ˆé©¬é©¬è™è™å†™ä¸€ä¸‹ï¼Œæœ€åå†ä¿®æ”¹)

  ```js
  // Create Schema
  const UserSchema = new Schema({
    name: {
      type: String,
      required: true,
    },
    email: {
      type: String,
      required: true,
    },
    password: {
      type: String,
      required: true,
    },
    avatar: {
      type: String,
    },
    date: {
      type: Date,
      default: Date.now
    }
  });
  ```

- æœ€åä½¿ç”¨ä½¿ç”¨è§„åˆ™åˆ›å»ºé›†åˆï¼Œå¹¶æš´éœ²å‡ºå»

  modelé‡Œçš„å‚æ•°ï¼šï¼ˆé›†åˆåç§°ï¼Œé›†åˆè§„åˆ™ï¼‰

  ```js
  module.exports = User = mongoose.model("users", UserSchema);
  ```

â†“

æ­å»ºç”¨æˆ·ç™»å½•é¡µé¢çš„registeræ¥å£ï¼š

- å› ä¸ºæ³¨å†Œçš„æ—¶å€™ä¸€å®šä¼šä¼ é€’ä¸€äº›å¯¹åº”ä¿¡æ¯ï¼Œæ‰€ä»¥è¦æ”¹ç”¨postè¯·æ±‚

- å®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å— bodyParser -- npm install body-parser

- åœ¨å…¥å£æ–‡ä»¶ä¸­å¼•å…¥body-parserï¼šconst bodyParser = **require**("body-parser");

- // *ä½¿ç”¨body-parserä¸­é—´ä»¶*

  app.**use**(bodyParser.**urlencoded**({ extended: **false** }));

  app.**use**(bodyParser.**json**());

- åœ¨è·¯ç”±user.jsä¸­å¼•å…¥Useræ¨¡å—ï¼Œæ·»åŠ postè¯·æ±‚

  ```js
  // $route GET api/users/register
  // @desc  è¿”å›è¯·æ±‚çš„jsonæ•°æ®
  // @access public
  router.post("/register", (req, res) => {
    // console.log(req.body);
    //æŸ¥è¯¢æ•°æ®åº“ä¸­æ˜¯å¦æ‹¥æœ‰é‚®ç®±
    User.findOne({ email: req.body.email }).then((user) => {
      if (user) {
        return res.status(400).json({ email: "é‚®ç®±å·²è¢«æ³¨å†Œ" });
      } else {
        const newUser = new User({
          name: req.body.name,
          email: req.body.email,
          avatar: avatar,
          password: req.body.password,
        });
      }
    });
  });
  ```

- å¦‚æœè¦ç»™å¯†ç ï¼Œéœ€è¦å®‰è£…bcrypt----npm install bcryptï¼Œå¹¶åœ¨å½“å‰æ–‡ä»¶å¼•å…¥

  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwfpdbj59j30v90acdhk.jpg)

  ```js
  // ç»™å¯†ç åŠ å¯†
  bcrypt.genSalt(10, function (err, salt) {
    bcrypt.hash(newUser.password, salt, (err, hash) => {
      if (err) throw err; // å¦‚æœå‡ºé”™äº† ç›´æ¥æŠ›å‡ºé”™è¯¯
      newUser.password = hash;  // å¯†ç å˜æˆhashå€¼
      newUser
        .save()   //è°ƒç”¨saveå­˜å‚¨æ•°æ®
        .then(user => res.json(user))       //å¹¶ä¸”ä½†ä¼šjsonå¯¹è±¡
        .catch((err) => console.log(err));   //å¦‚æœé”™è¯¯åˆ™æ‰“å°é”™è¯¯
    });
  });
  ```

- æµ‹è¯•ä¸‹æ˜¯å¦èƒ½è®²å½“å‰æ•°æ®å­˜åˆ°æ•°æ®åº“ä¸­
  å‡ºç°æŠ¥é”™ ï¼š

  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwfpem9jwj30no03smxs.jpg)

  è§£å†³ï¼šå¯èƒ½æ˜¯æ— æ³•è¯†åˆ«ES6è¯­æ³•ï¼ŒæŠŠç®­å¤´å‡½æ•°æ”¹ä¸ºæ™®é€šå‡½æ•°, thow err æ”¹ä¸º return err

  ```js
  bcrypt.hash(newUser.password, 10, function (err, hash) {
    if (err) {
      return err;
    }
    newUser.password = hash;
    newUser
      .save()
      .then((user) => res.json(user))
      .catch((err) => console.log(err));
  });
  ```

  è¿è¡Œåå¯åœ¨postmanä¸­æ‹¿åˆ°åŠ å¯†è¿‡åçš„æ•°æ®
  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwfpe2o0wj30iy04n0t4.jpg)

  å®Œæ•´çš„è¯·æ±‚ğŸ‘‡
  <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghwf820ayxj30ds069wex.jpg" style="zoom:150%;" />

  <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghwf8e38r3j30bi065jrq.jpg" style="zoom:150%;" />

  <img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghwf920x46j30vy02dq32.jpg" style="zoom:200%;" />

- æ¥åˆ°MongoDB Compassçš„æ§åˆ¶é¢æ¿é‡Œï¼ŒæŸ¥çœ‹æ•°æ®åº“ä¸­æ–°å¢äº†testç›®å½•ï¼Œé‡Œé¢ä¿å­˜äº†usersï¼Œæ•°æ®å·²ç»ä¼ ä¸Šæ¥å•¦~

  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwfpfyvznj30rk0dmabj.jpg)

â†“

å…³äºå¤´åƒçš„é—®é¢˜avartar---ä½¿ç”¨ç¬¬ä¸‰æ–¹gravatar

- npm install gravatar

- åœ¨éœ€è¦ä½¿ç”¨çš„åœ°æ–¹ï¼ˆusers.js)ä¸­å¼•å…¥ï¼Œconst gravatar = **require**("gravatar");

- åœ¨newUserä¹‹å‰ï¼Œå®šä¹‰avatarå…ˆ 
  (å®˜ç½‘copy)ï¼š

  - urlä»£è¡¨gravatarä¸‹çš„ä¸€ä¸ªæ–¹æ³•ï¼Œæ¥å—2ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ç”¨æˆ·é‚®ç®±ï¼Œç¬¬äºŒä¸ªæ˜¯ä¸€äº›optionsï¼Œ
    - s: size
    - r:rating   ï¼ˆå¯èƒ½æ˜¯ä¸€ç§å›¾ç‰‡çš„å‚æ•°ï¼‰
    - d:default

  ```js
  var url = gravatar.url('emerleite@gmail.com', {s: '200', r: 'pg', d: '404'});
  ```

  - å¯¹ä»£ç ç¨ä½œæ”¹åŠ¨

    ```js
    const avatar = gravatar.url("req.body.email", {
            s: "200",
            r: "pg",
            d: "mm",
          });
    ```

- åœ¨postmanä¸­ç”¨ä¸€ä¸ªæ–°é‚®ç®±æµ‹è¯•ä¸€ä¸‹ï¼Œæ­¤æ—¶å·²ç»æ‹¿åˆ°äº†avatarçš„åœ°å€
  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwfzpzvmkj30jj050dgg.jpg)

  è¿™ä¸ªåœ°å€æ˜¾ç¤ºçš„å›¾åƒæ˜¯ä»‹ä¸ªæ ·å­ğŸ‘‰<img src="https://tva1.sinaimg.cn/large/007S8ZIlly1ghwg23njtcj305p05smwy.jpg" style="zoom:80%;" />

  å¦‚æœç”¨çœŸå®çš„ï¼Œè®¾ç½®è¿‡avatarå¤´åƒçš„é‚®ç®±æ¥åšavatarè¯·æ±‚ï¼Œåˆ™ä¼šæ‹¿åˆ°ä½ çœŸå®çš„å¤´åƒå“¦~



â†“

æ­å»ºç™»å½•æ¥å£ï¼š

- ç»§ç»­åœ¨users.jsé‡Œæ·»åŠ ç™»å½•æ¥å£ï¼Œæ­¤æ—¶è¦æ±‚è¿”å›tokenï¼Œ jwt passport

- æ‹¿åˆ°emailå’Œpasswordä¹‹åä¸æ•°æ®åº“è¿›è¡ŒåŒ¹é…ï¼Œ å¯†ç åŒ¹é…è¿™é‡Œç”¨åˆ°äº†bcrypté‡Œé¢çš„compare
  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwgktc25vj30o203n74q.jpg)

  ```js
  bcrypt.compare(password, user.password).then((isMatch) => {
    if (isMatch) {
      res.json({ msg: "success" });
    } else {
      return res.status(400).json({ password: "å¯†ç é”™è¯¯" });
    }
  });
  ```

  å…ˆä¸åštokenï¼Œåœ¨res.jsoné‡Œç›´æ¥è¿”å›msg, çœ‹ä¸‹èƒ½å¦åœ¨é‚®ç®±æ­£ç¡®ï¼Œé”™è¯¯ï¼Œå¯†ç æ­£ç¡®ï¼Œé”™è¯¯çš„æƒ…å†µä¸‹èƒ½å¦æ­£ç¡®è¿”å›ï¼š

  æ­£ç¡®æƒ…å†µä¸‹ğŸ‘‡ï¼š
  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwgqxb9xzj30fu0b4dg9.jpg)
  é‚®ç®±é”™è¯¯ğŸ‘‡ï¼š
  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwgsmr166j30e509wt91.jpg)

  å¯†ç é”™è¯¯ğŸ‘‡ï¼š

  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwgt8vdvsj30du0a6glx.jpg)

- è¿”å›tokenï¼š

  - npm install jsonwebtoken

  - å¼•å…¥jsonwebtokenï¼Œèµ·åjwt

  - è°ƒç”¨jwt.signæ–¹æ³•ï¼Œä¼ é€’ç›¸åº”è§„åˆ™ï¼š        jwt.**sign**("è§„åˆ™", "åŠ å¯†åå­—", "è¿‡æœŸæ—¶é—´", "ç®­å¤´å‡½æ•°");
    åŠ å¯†åå­—secretå¯ä»¥åœ¨keysé‡Œé¢æå‰å®šä¹‰å¥½:  secretOrKey: "secret",
    â†“

    ```js
    bcrypt.compare(password, user.password).then((isMatch) => {
      if (isMatch) {
        const rule = { id: user.id, name: user.name };
        jwt.sign(rule, keys.secretOrKey, { expiresIn: 3600 }, (err, token) => {
          if (err) throw err;
          res.json({
            success: true,
            token: "Bearer " + token,   //Beareråæœ‰ä¸€ä¸ªç©ºæ ¼
          });
        });
      } else {
        return res.status(400).json({ password: "å¯†ç é”™è¯¯" });
      }
    });
    ```

  - è°ƒè¯•ä¸‹~ ok~æ‹¿åˆ°token

    ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwi4bgprmj30ok0c3dh4.jpg)

â†“

éªŒè¯tokenï¼š

- ```js
  // $route GET api/users/current
  // @desc  return current user
  // @access private
  router.get("/current", "éªŒè¯token", (req, res) => {
    res.json({ msg: "success" });
  });
  ```

- ç”¨åˆ°passportæ¥éªŒè¯token

  - npm install passport  passport-jwt

  - åœ¨å…¥å£æ–‡ä»¶ä¸­å…ˆå¼•å…¥passportï¼Œ å¹¶åˆå§‹åŒ–passportï¼šapp.use(passport.initialize())

    ```js
    // passport åˆå§‹åŒ–
    app.use(passport.initialize());
    // å¼•å…¥passport.jsä»£ç ï¼ŒåŒæ—¶æŠŠä¸Šé¢constçš„passportä¼ é€’ï¼Œè¿™æ ·ç›´æ¥æŠŠä»£ç å†™åœ¨passport.jsé‡Œ
    require("./config/passport")(passport);
    ```

  - åœ¨å¦å¤–å•ç‹¬æ–‡ä»¶å¤¹ä¸­é…ç½®passport

    - config-->æ–°å»ºpassport.js , åœ¨passport-jwtå®˜ç½‘ä¸‹å¼•å…¥ç›¸å…³é…ç½®

  ```js
  const JwtStrategy = require("passport-jwt").Strategy,
    ExtractJwt = require("passport-jwt").ExtractJwt;
  const mongoose = require("mongoose");
  const User = mongoose.model("users");
  
  const keys = require("../config/keys");
  
  const opts = {};
  opts.jwtFromRequest = ExtractJwt.fromAuthHeaderAsBearerToken();
  opts.secretOrKey = keys.secretOrKey;
  
  module.exports = (passport) => {};
  ```

  â†“

  ```js
  module.exports = (passport) => {
    passport.use(
      new JwtStrategy(opts, (jwt_payload, done) => {
        console.log(jwt_payload);
      })
    );
  };
  ```

  â†“

  é…ç½®å®Œæˆï¼Œæ¥åˆ°users.js å¼•å…¥passportåï¼Œæ·»åŠ æ¥å£

  ```js
  // $route GET api/users/current
  // @desc  return current user
  // @access private
  router.get(
    "/current",
    passport.authenticate("jwt", { session: false }),
    (req, res) => {
      res.json({ msg: "success" });
    }
  );
  ```

  å°†åˆšæ‹¿åˆ°çš„tokenï¼Œæ”¾åˆ°currentæ¥å£çš„headerä¸­ï¼Œæµ‹è¯•ä¸€ä¸‹ï¼Œç»ˆç«¯ä¼šè¿”å›ï¼Œå› ä¸ºåœ¨passport.useé‡Œæˆ‘ä»¬å†™äº†console.log~  ğŸ‘†
  ğŸ‘‡
  ![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwi70e0u2j30ae03k749.jpg)


  â†“

  æ—¢ç„¶æ‹¿åˆ°äº†æ•°æ®ï¼Œå°±å¯ä»¥é€šè¿‡æŸ¥è¯¢åè¿”å›ç”¨æˆ·ä¿¡æ¯

  ```js
  module.exports = (passport) => {
    passport.use(
      new JwtStrategy(opts, (jwt_payload, done) => {
        console.log(jwt_payload);
        User.findById(jwt_payload.id)
          .then((user) => {
            if (user) {
              return DOMError(null, user);
            }
            return done(null, false);
          })
          .catch((err) => console.log(err));
      })
    );
  };
  ```

  â†“

  è°ƒæ•´ä¸‹è¿”å›çš„ä»£ç ï¼Œåªè¿”å›userå¯¹è±¡ä¸­çš„id,name, email 

  ```js
  // $route GET api/users/current
  // @desc  return current user
  // @access private
  router.get(
    "/current",
    passport.authenticate("jwt", { session: false }),
    (req, res) => {
      res.json({
        id: req.user.id,
        name: req.user.name,
        email: req.user.email,
      });
    }
  );
  ```

  

â†“

å¢åŠ èº«ä»½å­—æ®µï¼Œæ·»åŠ æƒé™ï¼ˆé¡¹ç›®ä¸­ç”¨ä¸åˆ°æƒé™ç®¡ç†çš„å¯ä»¥å¿½ç•¥è¿™ä¸€æ­¥ï¼‰

- åœ¨User.jsé‡Œæ·»åŠ identityå­—æ®µ
- åœ¨users.js æ¥å£æ–‡ä»¶ä¸­çš„newUserä¸­è¡¥ä¸Šidentity
- åœ¨ç™»å½•æ¥å£ä½ç½®ï¼Œåœ¨isMathè§„åˆ™å¤„å’Œres.jsonå¤„æ·»åŠ identity

â†“

loginã€registerã€current ä¸‰ä¸ªæ¥å£æµ‹è¯•é€šè¿‡
![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwjusnjrvj30l00f9q4l.jpg)

![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwjv4a1roj30na0eegnj.jpg)

![](https://tva1.sinaimg.cn/large/007S8ZIlly1ghwjwn1ssbj30kg04amxd.jpg)

â†“
æ˜å¤©ç»§ç»­~ æ™šå®‰ğŸ¶